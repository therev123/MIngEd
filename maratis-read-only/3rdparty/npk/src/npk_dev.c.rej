--- 3rdparty/npk/src/npk_dev.c	(revision 126)
+++ 3rdparty/npk/src/npk_dev.c	(working copy)
@@ -1,17 +1,17 @@
 /*
 
-    npk - General-Purpose File Packing Library
+    npk - neat package system
     See README for copyright and license information.
 
 */
 
 #include <stdio.h>
 #include <stdlib.h>
+#include <stddef.h>
 #include <stdarg.h>
 #include <time.h>
 #include <errno.h>
 #include <fcntl.h>
-#include <memory.h>
 #include <string.h>
 #include <sys/types.h>
 #include <sys/stat.h>
@@ -112,22 +112,28 @@
 {
     if( handle != 0 )
     {
+        if(__commit == NULL)
 #ifdef NPK_PLATFORM_WINDOWS
-    _commit( handle );
+            _commit( handle );
 #else
-    fsync( handle );
+            fsync( handle );
 #endif
+        else
+            __commit( (void*)handle );
     }
     return NPK_SUCCESS;
 }
 
 long npk_tell( NPK_HANDLE handle )
 {
+    if(__seek == NULL)
 #ifdef NPK_PLATFORM_WINDOWS
-    return _lseek( handle, 0, SEEK_CUR );
+        return _lseek( handle, 0, SEEK_CUR );
 #else
-    return lseek( handle, 0, SEEK_CUR );
+        return lseek( handle, 0, SEEK_CUR );
 #endif
+    else
+        return __seek( (void*)handle, 0, SEEK_CUR );
 }
 
 NPK_RESULT npk_write( NPK_HANDLE handle, const void* buf, NPK_SIZE size,
@@ -150,7 +156,10 @@
             if( (int)( size - totalwritten ) < unit )
                 unit = size - totalwritten;
 
-            currentwritten = write( handle, (NPK_STR)buf + totalwritten, (unsigned int)unit );
+            if( __write == NULL)
+                currentwritten = write( handle, (NPK_STR)buf + totalwritten, (unsigned int)unit );
+            else
+                currentwritten = __write( (NPK_STR)buf + totalwritten, sizeof(char*), (unsigned int)unit, (void*)handle );
 
             if( currentwritten < unit )
             {
@@ -257,7 +266,7 @@
     void*               buf = NULL;
     void*               buf_for_zlib = NULL;
     NPK_SIZE            size, endpos, startpos;
-    int                 filehandle;
+    NPK_HANDLE          filehandle;
     int                 z_res;
 
     if( !eb )
@@ -453,7 +462,7 @@
     NPK_SIZE            len;
     int                 savecount = 0;
     NPK_STR             savefilename = NULL;
-    int                 savefilehandle;
+    NPK_HANDLE          savefilehandle;
     NPK_CHAR*           buf;
     NPK_CHAR*           buf_pos;
     NPK_PACKAGEINFO_V23 header_v23;
