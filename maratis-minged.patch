Index: trunk/dev/MSDK/MGui/Sources/MGui.cpp
===================================================================
--- trunk/dev/MSDK/MGui/Sources/MGui.cpp	(revision 102)
+++ trunk/dev/MSDK/MGui/Sources/MGui.cpp	(working copy)
@@ -28,7 +28,7 @@
 //========================================================================
 
 
-#include <MLoaders/MDevILLoader.h>
+//#include <MLoaders/MDevILLoader.h>
 #include "../Includes/MGui.h"
 
 
@@ -49,7 +49,14 @@
 	render->loadIdentity();
 }
 
+imageLoadFunc MImageLoadFunc;
 
+void setImageLoader(imageLoadFunc func)
+{
+  MImageLoadFunc = func;
+}
+
+
 // MGui
 MGui::MGui(void):
 m_render(NULL)
@@ -108,7 +115,8 @@
 	}
 
 	MImage image;
-	if(M_loadImage(filename, &image))
+	
+	if(m_imageLoader.loadData(filename, &image))
 	{
 		MGuiTexture * texture = new MGuiTexture();
 
Index: trunk/dev/MSDK/MGui/Sources/X11/MX11Window.cpp
===================================================================
--- trunk/dev/MSDK/MGui/Sources/X11/MX11Window.cpp	(revision 102)
+++ trunk/dev/MSDK/MGui/Sources/X11/MX11Window.cpp	(working copy)
@@ -30,6 +30,7 @@
 //========================================================================
 
 
+#include "../../Includes/MGui.h"
 #include "../../Includes/MWindow.h"
 
 #include <stdlib.h>
@@ -39,9 +40,9 @@
 #include <X11/extensions/xf86vmode.h>
 #include <GL/gl.h>
 #include <GL/glx.h>
+#include <unistd.h>
 
 
-
 // start time
 static struct timeval startTime;
 
@@ -251,6 +252,20 @@
 	return currentDirectory;
 }
 
+const char* MWindow::getUserDirectory(void)
+{
+  static char dir[0xff];
+  snprintf(dir, 0xff, "%s/.Maratis/", getenv("HOME"));
+  return dir;
+}
+
+const char* MWindow::getSystemDirectory(void)
+{
+  static char dir[0xff];
+  snprintf(dir, 0xff, "%s/", getenv("MSDKDIR"));
+  return dir;
+}
+
 void MWindow::setCursorPos(int x, int y)
 {
 	XWarpPointer(display, None, window, 0, 0, 0, 0, x, y);
@@ -442,8 +457,9 @@
 
 				int car = translateChar(&event.xkey);
 
-				if(car == 127 || car == 32 || car == 13 || car == 9) // not return, space, delete etc..
-					break;
+				//if(car == 127 || car == 32 || car == 13 || car == 9) // not return, space, delete etc..
+				if(car == -1)
+				      break;
 
 				mevent.type = MWIN_EVENT_CHAR;
 				mevent.data[0] = car;
Index: trunk/dev/MSDK/MGui/Includes/X11/MX11Window.h
===================================================================
--- trunk/dev/MSDK/MGui/Includes/X11/MX11Window.h	(revision 102)
+++ trunk/dev/MSDK/MGui/Includes/X11/MX11Window.h	(working copy)
@@ -124,6 +124,8 @@
 	const char * getTempDirectory(void);
 	const char * getCurrentDirectory(void);
 	inline const char * getWorkingDirectory(void){ return m_workingDirectory; }
+	const char* getUserDirectory(void);
+	const char* getSystemDirectory(void);
 
 	// joysticks
 	MJoystick * getJoystick1(void){ return &m_joysticks[0]; }
Index: trunk/dev/MSDK/MGui/Includes/MWindow.h
===================================================================
--- trunk/dev/MSDK/MGui/Includes/MWindow.h	(revision 102)
+++ trunk/dev/MSDK/MGui/Includes/MWindow.h	(working copy)
@@ -31,10 +31,11 @@
 #ifndef _M_WINDOW_H
 #define _M_WINDOW_H
 
-#include <MWinEvents.h>
-#include <MMouse.h>
-#include <MKeyboard.h>
-#include <MJoystick.h>
+#include "MWinEvents.h"
+#include "MGui.h"
+#include "MMouse.h"
+#include "MKeyboard.h"
+#include "MJoystick.h"
 
 #ifdef WIN32
 	#include "WIN32/MWin32Window.h"
Index: trunk/dev/MSDK/MGui/Includes/MGui.h
===================================================================
--- trunk/dev/MSDK/MGui/Includes/MGui.h	(revision 102)
+++ trunk/dev/MSDK/MGui/Includes/MGui.h	(working copy)
@@ -32,6 +32,25 @@
 #define _M_GUI_H
 
 
+#ifdef WIN32
+
+	// M_GUI_EXPORT
+	#if defined(MGUI_DLL)
+		#define M_GUI_EXPORT __declspec( dllexport )
+	#elif defined(MGUI_STATIC)
+		#define M_GUI_EXPORT
+	#else
+		#define M_GUI_EXPORT __declspec( dllimport )
+	#endif
+
+#else
+
+	// M_GUI_EXPORT
+	#define M_GUI_EXPORT
+
+#endif
+
+
 // variable types
 enum M_VAR_TYPE
 {
@@ -70,12 +89,15 @@
 #include "MGuiFileBrowser.h"
 
 
+typedef bool(*imageLoadFunc)(const char*, void*);
+
 // global functions
 void set2dMode(MRenderingContext * render);
+void setImageLoader(imageLoadFunc func);
 
 
 // gui texture
-class MGuiTexture
+class M_GUI_EXPORT MGuiTexture
 {
 public:
 
@@ -84,7 +106,7 @@
 };
 
 // MGui
-class MGui
+class M_GUI_EXPORT MGui
 {
 public:
 
@@ -112,11 +134,15 @@
 	// windows
 	std::vector <MGuiWindow *> m_windows;
 
+	MDataLoader m_imageLoader;
+
 public:
 
 	// rendering context
 	void setRenderingContext(MRenderingContext * render){ m_render = render; }
 	MRenderingContext * getRenderingContext(void){ return m_render; }
+	
+	MDataLoader * getImageLoader(void){ return &m_imageLoader; }
 
 	// windows
 	void unHighLightAllWindows(void);
Index: trunk/dev/MSDK/MEngine/Includes/MEngine.h
===================================================================
--- trunk/dev/MSDK/MEngine/Includes/MEngine.h	(revision 102)
+++ trunk/dev/MSDK/MEngine/Includes/MEngine.h	(working copy)
@@ -49,6 +49,8 @@
 
 #endif
 
+// for plugin compatability checking
+#define MPLUGIN_AVAILABLE
 
 // object3d type
 #define M_OBJECT3D			0
Index: trunk/dev/MSDK/MCore/Sources/MFileTools.cpp
===================================================================
--- trunk/dev/MSDK/MCore/Sources/MFileTools.cpp	(revision 102)
+++ trunk/dev/MSDK/MCore/Sources/MFileTools.cpp	(working copy)
@@ -41,6 +41,7 @@
 	#define rmdir _rmdir
 #else
 	#define mkdir(file) mkdir(file, 0777)
+        #include <unistd.h>
 #endif
 
 static MFileOpenHook* s_fileOpenHook = 0;
Index: trunk/dev/MSDK/MCore/Includes/MRenderingContext.h
===================================================================
--- trunk/dev/MSDK/MCore/Includes/MRenderingContext.h	(revision 102)
+++ trunk/dev/MSDK/MCore/Includes/MRenderingContext.h	(working copy)
@@ -389,6 +389,9 @@
 	virtual void enableBlending(void) = 0;
 	virtual void disableBlending(void) = 0;
 	virtual void setBlendingMode(M_BLENDING_MODES mode) = 0;
+
+	// points
+	virtual void setPointSize(float min, float max, float threshold) = 0;
 };
 
 #endif
Index: trunk/dev/MSDK/MCore/Includes/MPhysicsContext.h
===================================================================
--- trunk/dev/MSDK/MCore/Includes/MPhysicsContext.h	(revision 102)
+++ trunk/dev/MSDK/MCore/Includes/MPhysicsContext.h	(working copy)
@@ -50,6 +50,7 @@
 
 	// world
 	virtual void setWorldGravity(const MVector3 & gravity) = 0;
+	virtual MVector3 getWorldGravity() = 0;
 
 	// create object
 	virtual void createGhost(unsigned int * objectId, unsigned int shapeId, const MVector3 & position, const MQuaternion & rotation) = 0;
@@ -110,4 +111,4 @@
 	virtual void deleteConstraint(unsigned int * constraintId) = 0;
 };
 
-#endif
\ No newline at end of file
+#endif
Index: trunk/dev/MSDK/MCore/Includes/MSystemContext.h
===================================================================
--- trunk/dev/MSDK/MCore/Includes/MSystemContext.h	(revision 102)
+++ trunk/dev/MSDK/MCore/Includes/MSystemContext.h	(working copy)
@@ -50,6 +50,10 @@
 
 	// system tick
 	virtual unsigned long getSystemTick(void) = 0;
+	
+	// Store directories
+	virtual const char* getUserDirectory(void) = 0;
+	virtual const char* getSystemDirectory(void) = 0;
 };
 
-#endif
\ No newline at end of file
+#endif
Index: trunk/dev/Maratis/Common/MPlugin/MPlugin.h
===================================================================
--- trunk/dev/Maratis/Common/MPlugin/MPlugin.h	(revision 102)
+++ trunk/dev/Maratis/Common/MPlugin/MPlugin.h	(working copy)
@@ -31,33 +31,111 @@
 #ifndef _M_PLUGIN_H
 #define _M_PLUGIN_H
 
-#ifdef WIN32
-#include <windows.h>
-#else
-#include <dlfcn.h>
-#endif
+#ifdef MPLUGIN_DYNAMIC
+#  ifdef WIN32
+#    include <windows.h>
+#    define MPLUGIN_EXPORT __declspec(dllexport)
+#  else
+// automagically exported
+#    define MPLUGIN_EXPORT
+#    include <dlfcn.h>
+#  endif /*WIN32*/
+#endif/*MPLUGIN_DYNAMIC*/
 
-class MPlugin
+typedef void * (*FunctionPtr)();
+
+class M_ENGINE_EXPORT MPlugin
 {
 public :
 
 	MPlugin(void);
 	~MPlugin(void);
 
-private :
+protected :
 
 	string m_filename;
-	
-#ifdef WIN32
-    HMODULE m_library;
+
+#ifdef MPLUGIN_DYNAMIC	
+#    ifdef WIN32
+	HMODULE m_library;
+#    else
+	void * m_library;
+#    endif
 #else
-	void * m_library;
+        FunctionPtr Start;
+        FunctionPtr End;
+
 #endif
-
+	bool m_loaded;
 public:
 	
 	void load(const char * filename);
 	inline const char * getFilename(void){ return m_filename.c_str(); }
+	inline bool isLoaded(void) { return m_loaded; }
 };
 
-#endif
\ No newline at end of file
+// Some nasty macros to help making plugins for both systems that can dynamically
+// load libraries (ie. sensible systems) and for annoying systems like iOS
+// where we can't have shared objects.
+//
+// to use, in the plugin somewhere do as follows:
+//------------AwesomePlugin.h---------------------------------------------------
+// #include <MPlugin.h>
+// 
+// MPLUGIN_DECLARE(MyAwesomePlugin);
+//------------AwesomePlugin.cpp-------------------------------------------------
+// #include "AwesomePlugin.h"
+//
+// MPLUGIN_START_IMPLEMENT(MyAwesomePlugin)
+// {
+//   // this is where you do your code
+// }
+//
+// MPLUGIN_END_IMPLEMENT(MyAwesomePlugin)
+// {
+//   // cleanup here
+// }
+//
+// Everything else should be taken care of
+
+#ifdef MPLUGIN_DYNAMIC
+#    define MPLUGIN_DECLARE(name)		\
+  extern "C" {					\
+  MPLUGIN_EXPORT void StartPlugin();		\
+  MPLUGIN_EXPORT void EndPlugin();		\
+  }
+
+#    define MPLUGIN_START_IMPLEMENT(name)	\
+  void StartPlugin()
+
+#    define MPLUGIN_END_IMPLEMENT(name)		\
+  void EndPlugin()
+#else
+#    define MPLUGIN_DECLARE(name)			\
+  void StartPlugin##name();				\
+  void EndPlugin##name();				\
+  class Plugin##name##AutoStart				\
+  {							\
+  public:						\
+    Plugin##name##AutoStart();				\
+  }							\
+  extern Plugin##name##AutoStart s_##name##AutoStarter;
+
+#   define MPLUGIN_START_IMPLEMENT(name)				\
+  Plugin##name##AutoStart s_##name##AutoStarter;			\
+  Plugin##name##AutoStart::Plugin##name##AutoStart()			\
+  {									\
+    AddPluginFunctions(#name, &StartPlugin##name, &EndPlugin##name);	\
+  }									\
+  void StartPlugin##name()
+
+#   define MPLUGIN_END_IMPLEMENT(name)		\
+  void EndPlugin##name()
+#endif/*MPLUGIN_DYNAMIC*/
+
+// don't worry about this:
+#ifndef MPLUGIN_DYNAMIC
+void AddPluginFunctions(const char* pluginName, FunctionPtr start, FunctionPtr end);
+#endif
+
+#endif
Index: trunk/dev/Maratis/Common/MPlugin/MPlugin.cpp
===================================================================
--- trunk/dev/Maratis/Common/MPlugin/MPlugin.cpp	(revision 102)
+++ trunk/dev/Maratis/Common/MPlugin/MPlugin.cpp	(working copy)
@@ -30,64 +30,145 @@
 
 #include <MEngine.h>
 #include "MPlugin.h"
+#include <MWindow.h>
+#include <MFileTools.h>
 
+#include <stdio.h>
 
-typedef void * (*FunctionPtr)();
+#ifndef MPLUGIN_DYNAMIC
+#include <map>
+typedef struct _plugin
+{
+  FunctionPtr Start;
+  FunctionPtr End;
+  _plugin() : Start(0), End(0) {}
+  _plugin(FunctionPtr s, FunctionPtr e) : Start(s), End(e) {}
+} plugin;
 
+typedef std::map<const char*, plugin> pluginmap;
+typedef pluginmap::iterator pluginiter;
+pluginmap g_plugindefs;
+
+void AddPluginFunctions(const char* pluginName, FunctionPtr start, FunctionPtr end)
+{
+  plugin p(start, end);
+  g_plugindefs[pluginName] = p;
+}
+#endif
+
+
 MPlugin::MPlugin(void)
 {
+#ifdef MPLUGIN_DYNAMIC
 	m_library = NULL;
+#else
+	Start= 0;
+	End = 0;
+#endif
+	m_loaded = false;
 }
 
 MPlugin::~MPlugin(void)
 {
-	if(m_library)
-	{	
-#ifdef WIN32
-		
-		FunctionPtr function = reinterpret_cast<FunctionPtr>(GetProcAddress(m_library, "EndPlugin"));
-		if(function)
-			 function();
-		FreeLibrary(m_library);
-		
-#else
-		
-		FunctionPtr function = (FunctionPtr)dlsym(m_library, "EndPlugin");
-		if(function)
-			function();
-		dlclose(m_library);
-		
+#ifdef MPLUGIN_DYNAMIC
+    if(m_library)
+    {
+#    ifdef WIN32
+	
+	FunctionPtr function = reinterpret_cast<FunctionPtr>(GetProcAddress(m_library, "EndPlugin"));
+	if(function)
+	    function();
+	FreeLibrary(m_library);
+	
+#    else
+	
+	FunctionPtr function = (FunctionPtr)dlsym(m_library, "EndPlugin");
+	if(function)
+	    function();
+	dlclose(m_library);
+	
+#    endif
+    }
+#else		
+    if(End)
+	End();
 #endif
-	}
 }
 
 void MPlugin::load(const char * filename)
 {
-#ifdef WIN32
+#ifdef MPLUGIN_DYNAMIC
+
+
+	char file[256];
+	MWindow* window = MWindow::getInstance();
+
+	char dirs[3][256];
+	snprintf(dirs[0], 256, window->getWorkingDirectory());
+	snprintf(dirs[1], 256, "%s/Plugins", window->getUserDirectory());
+	snprintf(dirs[2], 256, "%s/Plugins", window->getSystemDirectory());
 	
-    m_library = LoadLibrary(filename);
-    if(! m_library)
-		return;
+	for(int i = 0; i < 3; ++i)
+	{
+#    ifdef WIN32
+	  getGlobalFilename(file, dirs[i], (string(filename) + ".dll").c_str());
+#    elseif __APPLE__
+	  getGlobalFilename(file, dirs[i], (string(filename) + ".dylib").c_str());
+#    else // just assume a linux based os
+	  getGlobalFilename(file, dirs[i], (string(filename) + ".so").c_str());
+#    endif
 
+	  if(isFileExist(file))
+	     break;
+	}
+
+#    ifdef WIN32
+    
+    m_library = LoadLibrary(file);
+    if(! m_library);
+    return;
+    
     FunctionPtr function = reinterpret_cast<FunctionPtr>(GetProcAddress(m_library, "StartPlugin"));
     if(! function)
-		return;
+	return;
 
-	m_filename = filename;
+    m_filename = filename;
+    function();	
+    m_loaded = true;
+
+#    else
+    
+    m_library = dlopen(file, RTLD_LAZY);
+    if(! m_library)
+    {
+	printf("%s\n", dlerror());
+	return;
+    }
+    
+    FunctionPtr function = (FunctionPtr)dlsym(m_library, "StartPlugin");
+    if(! function)
+    {
+	printf(dlerror());
+	return;
+    }
+    
+    m_filename = filename;
     function();
-	
+    m_loaded = true;
+    
+#    endif
 #else
-	
-	m_library = dlopen(filename, RTLD_LAZY);
-	if(! m_library)
-		return;
-	
-	FunctionPtr function = (FunctionPtr)dlsym(m_library, "StartPlugin");
-	if(! function)
-		return;
-	
-	m_filename = filename;
-    function();
-
+    // still need to cut up the filename... or something
+    pluginiter iplug = g_plugindefs.find(filename);
+    if(iplug != g_plugindefs.end())
+    {
+	Start = iplug->second.Start;
+	End = iplug->second.End;
+    }
+    if(Start)
+    {
+        Start();
+	m_loaded = true;
+    }
 #endif
-}
\ No newline at end of file
+}
Index: trunk/dev/Maratis/Common/MContexts/MBulletContext.cpp
===================================================================
--- trunk/dev/Maratis/Common/MContexts/MBulletContext.cpp	(revision 102)
+++ trunk/dev/Maratis/Common/MContexts/MBulletContext.cpp	(working copy)
@@ -122,6 +122,14 @@
 	m_dynamicsWorld->setGravity(btVector3(gravity.x, gravity.y, gravity.z));
 }
 
+MVector3 MBulletContext::getWorldGravity()
+{
+	if(m_dynamicsWorld == NULL)
+		return MVector3(0.0f, 0.0f, 0.0f);
+	btVector3 gravity = m_dynamicsWorld->getGravity();
+	return MVector3(gravity.x(), gravity.y(), gravity.z());
+}
+
 // create object
 void MBulletContext::createGhost(unsigned int * objectId, unsigned int shapeId, const MVector3 & position, const MQuaternion & rotation)
 {
Index: trunk/dev/Maratis/Common/MContexts/MBulletContext.h
===================================================================
--- trunk/dev/Maratis/Common/MContexts/MBulletContext.h	(revision 102)
+++ trunk/dev/Maratis/Common/MContexts/MBulletContext.h	(working copy)
@@ -71,6 +71,7 @@
 
 	// world gravity
 	void setWorldGravity(const MVector3 & gravity);
+	MVector3 getWorldGravity();
 
 	// create object
 	void createGhost(unsigned int * objectId, unsigned int shapeId, const MVector3 & position, const MQuaternion & rotation);
@@ -131,4 +132,4 @@
 	void deleteConstraint(unsigned int * constraintId);
 };
 
-#endif
\ No newline at end of file
+#endif
Index: trunk/dev/Maratis/Common/MContexts/MWinContext.cpp
===================================================================
--- trunk/dev/Maratis/Common/MContexts/MWinContext.cpp	(revision 102)
+++ trunk/dev/Maratis/Common/MContexts/MWinContext.cpp	(working copy)
@@ -60,3 +60,16 @@
 	MWindow * window = MWindow::getInstance();
 	return window->getSystemTick();
 }
+	
+// plugin directories
+const char* MWinContext::getUserDirectory(void)
+{
+  MWindow * window = MWindow::getInstance();
+  return window->getUserDirectory();
+}
+
+const char* MWinContext::getSystemDirectory(void)
+{
+  MWindow * window = MWindow::getInstance();
+  return window->getSystemDirectory();
+}
Index: trunk/dev/Maratis/Common/MContexts/MGLContext.cpp
===================================================================
--- trunk/dev/Maratis/Common/MContexts/MGLContext.cpp	(revision 102)
+++ trunk/dev/Maratis/Common/MContexts/MGLContext.cpp	(working copy)
@@ -209,6 +209,9 @@
 
 	// anisotropic filtering
 	glGetFloatv(GL_MAX_TEXTURE_MAX_ANISOTROPY_EXT, &maxAnisotropy);
+
+	glEnable(GL_POINT_SPRITE);
+	glTexEnvi(GL_POINT_SPRITE, GL_COORD_REPLACE, GL_TRUE);
 }
 
 MGLContext::~MGLContext(void)
@@ -1177,3 +1180,13 @@
 		break;
 	}
 }
+
+void MGLContext::setPointSize(float min, float max, float threshold)
+{
+	//glPointParameterf(GL_POINT_FADE_THRESHOLD_SIZE, threshold);
+	glPointSize(max);
+	glPointParameterf(GL_POINT_SIZE_MIN, min);
+	glPointParameterf(GL_POINT_SIZE_MAX, max);
+	GLfloat attn[] = { 0.0f, 0.0f, 0.02f };
+	glPointParameterfv(GL_POINT_DISTANCE_ATTENUATION, attn);
+}
Index: trunk/dev/Maratis/Common/MContexts/MWinContext.h
===================================================================
--- trunk/dev/Maratis/Common/MContexts/MWinContext.h	(revision 102)
+++ trunk/dev/Maratis/Common/MContexts/MWinContext.h	(working copy)
@@ -51,6 +51,10 @@
 
 	// system tick
 	unsigned long getSystemTick(void);
+	
+	// plugin directories
+	const char* getUserDirectory(void);
+	const char* getSystemDirectory(void);
 };
 
-#endif
\ No newline at end of file
+#endif
Index: trunk/dev/Maratis/Common/MContexts/MGLContext.h
===================================================================
--- trunk/dev/Maratis/Common/MContexts/MGLContext.h	(revision 102)
+++ trunk/dev/Maratis/Common/MContexts/MGLContext.h	(working copy)
@@ -248,6 +248,9 @@
 	void enableBlending(void);
 	void disableBlending(void);
 	void setBlendingMode(M_BLENDING_MODES mode);
+
+	// points
+	void setPointSize(float min, float max, float threshold);
 };
 
 #endif
